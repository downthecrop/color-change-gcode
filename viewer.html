<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>G-code Checklist Viewer</title>
  <style>
    :root{
      --bg:#0b0c10; --card:#12141c; --card2:#0f1118;
      --text:#e8e9f0; --muted:rgba(232,233,240,.7); --muted2:rgba(232,233,240,.55);
      --border:rgba(232,233,240,.12); --accent:#7c5cff; --ok:#2dd4bf; --bad:#fb7185;
    }
    html, body { height: 100%; margin: 0; background:
      radial-gradient(1200px 800px at 15% 10%, rgba(124,92,255,.25), transparent 45%),
      radial-gradient(900px 600px at 85% 20%, rgba(45,212,191,.16), transparent 45%),
      var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .wrap { max-width: 860px; margin: 0 auto; padding: 18px 14px 64px; }
    .top {
      position: sticky; top: 0; z-index: 50;
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      padding: 14px 0 10px;
    }
    .row { display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap; }
    .title { font-weight: 900; letter-spacing: .2px; font-size: 18px; }
    .sub { color: var(--muted); font-size: 12px; margin-top: 4px; line-height: 1.35; }
    .btns { display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end; }
    button {
      appearance: none; border: 1px solid var(--border);
      background: rgba(18,20,28,.75);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 900;
      cursor: pointer;
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
    }
    button:hover { background: rgba(18,20,28,.95); border-color: rgba(232,233,240,.18); }
    button:active { transform: translateY(1px); }
    button.primary { background: rgba(124,92,255,.2); border-color: rgba(124,92,255,.35); }
    button.danger { background: rgba(251,113,133,.14); border-color: rgba(251,113,133,.32); }
    button:disabled { opacity: .5; cursor: not-allowed; }

    .card {
      margin-top: 14px;
      background: linear-gradient(to bottom, rgba(18,20,28,.88), rgba(18,20,28,.78));
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
      overflow: hidden;
    }
    .head {
      padding: 14px 14px 12px;
      border-bottom: 1px solid var(--border);
      background: rgba(15,17,24,.65);
      display: flex; gap: 10px; align-items: center; justify-content: space-between; flex-wrap: wrap;
    }
    .pill {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 8px 10px; border-radius: 14px;
      background: rgba(124,92,255,.12);
      border: 1px solid rgba(124,92,255,.25);
      font-size: 12px; color: var(--text);
      font-weight: 900;
    }
    .pillRow { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; justify-content: flex-end; }
    .progress {
      display: flex; align-items: center; gap: 10px;
      font-size: 12px; color: var(--muted);
      min-width: 240px;
    }
    .bar {
      flex: 1;
      height: 8px;
      background: rgba(232,233,240,.10);
      border: 1px solid rgba(232,233,240,.10);
      border-radius: 999px;
      overflow: hidden;
      min-width: 160px;
    }
    .bar > div { height: 100%; width: 0%; background: linear-gradient(90deg, rgba(124,92,255,.9), rgba(45,212,191,.9)); }
    .list { padding: 10px; display: grid; gap: 10px; }
    .step {
      display: grid;
      grid-template-columns: 46px 1fr auto;
      gap: 12px;
      align-items: center;
      padding: 12px 12px;
      background: rgba(15,17,24,.6);
      border: 1px solid rgba(232,233,240,.10);
      border-radius: 16px;
    }
    .step.next { border-color: rgba(124,92,255,.45); box-shadow: 0 0 0 2px rgba(124,92,255,.18) inset; }
    .idx {
      width: 46px; height: 46px;
      border-radius: 16px;
      display: grid; place-items: center;
      background: rgba(124,92,255,.16);
      border: 1px solid rgba(124,92,255,.28);
      font-weight: 900;
    }
    .meta { display: flex; flex-direction: column; gap: 3px; min-width: 0; }
    .load {
      font-size: 16px; font-weight: 1000; letter-spacing: .3px;
      text-transform: uppercase;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .loadRow { display:flex; align-items:center; gap:8px; min-width:0; }
    .swatch {
      width: 14px; height: 14px;
      border-radius: 999px;
      border: 1px solid rgba(232,233,240,.35);
      flex-shrink: 0;
      box-shadow: 0 0 0 1px rgba(0,0,0,.35);
    }
    .from {
      font-size: 12px; color: var(--muted2);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .tiny { font-size: 11px; color: var(--muted2); display: flex; gap: 10px; flex-wrap: wrap; }
    .check {
      display: inline-flex; align-items: center; gap: 10px;
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(18,20,28,.55);
      border: 1px solid rgba(232,233,240,.12);
      user-select: none;
      font-weight: 900;
    }
    .check input { width: 22px; height: 22px; accent-color: var(--ok); }
    .empty {
      padding: 16px;
      color: var(--muted);
      line-height: 1.35;
    }
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .toast {
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: 16px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(18,20,28,.92);
      border: 1px solid rgba(232,233,240,.14);
      box-shadow: 0 16px 50px rgba(0,0,0,.45);
      font-size: 12px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease;
      max-width: min(520px, calc(100vw - 28px));
      text-align: center;
    }
    .toast.show { opacity: 1; }
    .qrModal {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.55);
      display: none;
      align-items: center; justify-content: center;
      padding: 18px;
      z-index: 999;
    }
    .qrModal.show { display: flex; }
    .qrCard {
      width: min(420px, 100%);
      background: rgba(18,20,28,.95);
      border: 1px solid rgba(232,233,240,.14);
      border-radius: 18px;
      box-shadow: 0 28px 80px rgba(0,0,0,.55);
      padding: 14px;
    }
    .qrHead { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
    .qrTitle { font-weight: 1000; }
    canvas {
      display:block;
      margin:0 auto;
      border-radius:12px;
      background:#fff;
      width:100%;
      max-width:320px;
      height:auto;
    }
    .footerNote { margin-top: 10px; font-size: 11px; color: var(--muted2); word-break: break-all; text-align:center; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="step">
        <div>
          <div class="title" id="title">G-code Checklist</div>
          <div class="sub" id="sub">Open via <span class="mono">#d=...</span></div>
        </div>
        <div class="btns">
          <button id="btnShareQR" disabled>Share QR Code</button>
          <button class="danger" id="btnReset" disabled>Reset</button>
        </div>
      </div>
    </div>

    <div class="card" id="card">
      <div class="head">
        <div class="progress">
          <span id="progText">0 / 0</span>
          <div class="bar"><div id="progBar"></div></div>
        </div>
        <div class="pillRow">
          <div class="pill" id="startPill" style="display:none"></div>
          <div class="pill" id="pill">LOAD: —</div>
        </div>
      </div>
      <div class="list" id="list"></div>
      <div class="empty" id="empty" style="display:none"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="qrModal" id="qrModal" aria-hidden="true">
    <div class="qrCard">
      <div class="qrHead">
        <div class="qrTitle">Scan to open this checklist</div>
        <button id="btnCloseQR">Close</button>
      </div>
      <canvas id="qrCanvas" width="320" height="320"></canvas>
      <div class="footerNote" id="qrUrl"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.0/qrcode.min.js"></script>
  <script>
    const $ = (id) => document.getElementById(id);

    function toast(msg) {
      const t = $('toast');
      t.textContent = msg;
      t.classList.add('show');
      clearTimeout(toast._tm);
      toast._tm = setTimeout(() => t.classList.remove('show'), 1300);
    }

    function b64urlToBytes(s) {
      s = s.replace(/-/g, '+').replace(/_/g, '/');
      const pad = s.length % 4;
      if (pad) s += '='.repeat(4 - pad);
      const bin = atob(s);
      const out = new Uint8Array(bin.length);
      for (let i = 0; i < bin.length; i++) out[i] = bin.charCodeAt(i);
      return out;
    }

    async function inflate(bytes) {
      if (typeof DecompressionStream !== 'function') {
        throw new Error('DecompressionStream(deflate) not supported. Use Chrome/Edge/Firefox recent.');
      }
      const ds = new DecompressionStream('deflate');
      const blob = new Blob([bytes]);
      const stream = blob.stream().pipeThrough(ds);
      const ab = await new Response(stream).arrayBuffer();
      return new Uint8Array(ab);
    }

    function bytesToUtf8(bytes) {
      return new TextDecoder('utf-8').decode(bytes);
    }

    function parseTokenFromUrl() {
      const hash = location.hash.startsWith('#') ? location.hash.slice(1) : location.hash;
      if (hash) {
        const p = new URLSearchParams(hash.startsWith('d=') ? hash : hash.replace(/^#/, ''));
        const d = p.get('d');
        if (d) return d;
      }
      const sp = new URLSearchParams(location.search);
      return sp.get('d');
    }

    async function sha256Hex(str) {
      const data = new TextEncoder().encode(str);
      const buf = await crypto.subtle.digest('SHA-256', data);
      const b = new Uint8Array(buf);
      let s = '';
      for (const x of b) s += x.toString(16).padStart(2, '0');
      return s;
    }

    function lsGet(key) {
      try { return JSON.parse(localStorage.getItem(key) || 'null'); } catch { return null; }
    }
    function lsSet(key, value) { localStorage.setItem(key, JSON.stringify(value)); }

    function el(tag, cls, text) {
      const e = document.createElement(tag);
      if (cls) e.className = cls;
      if (text != null) e.textContent = text;
      return e;
    }

    function escapeHtml(s) {
      return (s || '')
        .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }
    function startColorName(steps) {
      if (!Array.isArray(steps)) return '';
      for (const s of steps) {
        const from = (s.from || '').trim();
        if (from) return from;
      }
      return '';
    }

    function guessColor(name) {
      const n = (name || '').toLowerCase();
      const palette = [
        [/black|onyx|carbon/, '#0f1118'],
        [/white|ivory|snow|pearl/, '#f0f2f7'],
        [/gray|grey|slate|graphite|ash|smoke/, '#9ca3af'],
        [/silver|chrome|steel/, '#c8cdd4'],
        [/red|crimson|scarlet|ruby/, '#ef4444'],
        [/orange|amber|tangerine|coral/, '#f97316'],
        [/yellow|gold|mustard|sun/, '#facc15'],
        [/green|lime|mint|emerald|jade|olive/, '#22c55e'],
        [/blue|azure|navy|cobalt|cyan|teal|turquoise|aqua/, '#3b82f6'],
        [/purple|violet|magenta|plum|lavender/, '#a855f7'],
        [/pink|rose|fuchsia/, '#ec4899'],
        [/brown|mocha|coffee|choco|walnut|wood/, '#a16246'],
        [/bronze|copper/, '#b45309'],
        [/clear|transparent/, '#d1d5db']
      ];
      for (const [re, color] of palette) {
        if (re.test(n)) return color;
      }
      return '#7c5cff';
    }
    function textColorFor(hex) {
      const m = /^#?([0-9a-f]{6})$/i.exec(hex || '');
      if (!m) return '#0b0c10';
      const v = m[1];
      const r = parseInt(v.slice(0,2), 16);
      const g = parseInt(v.slice(2,4), 16);
      const b = parseInt(v.slice(4,6), 16);
      const lum = (0.2126*r + 0.7152*g + 0.0722*b) / 255;
      return lum > 0.6 ? '#0b0c10' : '#f8fafc';
    }

    function qrSizeFor(canvasEl) {
      const parentWidth = canvasEl.parentElement ? canvasEl.parentElement.getBoundingClientRect().width : 320;
      const usable = Math.max(200, Math.floor(parentWidth - 32));
      return Math.min(320, usable);
    }

    async function drawQr(canvasEl, text) {
      const size = qrSizeFor(canvasEl);
      canvasEl.width = canvasEl.height = size;
      await QRCode.toCanvas(canvasEl, text, { errorCorrectionLevel: 'M', margin: 1, width: size });
    }

    function buildStepRow(step, checked, onToggle) {
      const row = el('div', 'step');
      row.dataset.idx = String(step.i);

      const idx = el('div', 'idx', String(step.i));
      const loadText = (step.to || '(unknown)').trim();
      const color = guessColor(loadText);
      idx.style.background = color;
      idx.style.borderColor = 'rgba(124,92,255,.45)';
      idx.style.color = textColorFor(color);

      const meta = el('div', 'meta');

      const load = el('div', 'load', loadText.toUpperCase());
      const loadRow = el('div', 'loadRow');
      loadRow.appendChild(load);

      if (step.from) {
        const from = el('div', 'from');
        from.innerHTML = '<span style="text-decoration:line-through;">' + escapeHtml(step.from) + '</span>';
        meta.appendChild(from);
        meta.insertBefore(loadRow, from);
      } else {
        meta.appendChild(loadRow);
      }

      const tiny = el('div', 'tiny');
      const a = [];
      if (step.z != null && String(step.z) !== '') a.push('Z ' + step.z + 'mm');
      if (step.layer != null && String(step.layer) !== '') a.push('Layer ' + step.layer);
      if (a.length) { tiny.textContent = a.join(' • '); meta.appendChild(tiny); }

      const chk = el('label', 'check');
      const input = document.createElement('input');
      input.type = 'checkbox';
      input.checked = !!checked;
      input.addEventListener('change', () => onToggle(step.i, input.checked));
      const lab = el('div', null, 'Done');
      chk.appendChild(input);
      chk.appendChild(lab);

      row.appendChild(idx);
      row.appendChild(meta);
      row.appendChild(chk);

      return row;
    }

    function updateProgressUI(payload, checkedArr) {
      const total = payload.steps.length;
      const done = checkedArr.reduce((a,b)=>a+(b?1:0),0);
      $('progText').textContent = done + ' / ' + total;

      const pct = total ? (done / total) : 0;
      $('progBar').style.width = (pct * 100).toFixed(1) + '%';

      let nextIdx = -1;
      for (let i=0;i<total;i++){ if(!checkedArr[i]){ nextIdx=i; break; } }

      if (nextIdx >= 0) {
        const nxt = payload.steps[nextIdx];
        $('pill').textContent = 'LOAD: ' + (nxt.to || '(unknown)').toUpperCase();
      } else {
        $('pill').textContent = 'DONE';
      }

      $('list').querySelectorAll('.step').forEach(r => r.classList.remove('next'));
      if (nextIdx >= 0) {
        const id = payload.steps[nextIdx].i;
        const row = $('list').querySelector('.step[data-idx="' + String(id) + '"]');
        if (row) row.classList.add('next');
      }

      $('btnReset').disabled = false;
      $('btnShareQR').disabled = false;
    }

    function normalizePayload(p) {
      if (!p || typeof p !== 'object') throw new Error('Bad payload');
      if (!Array.isArray(p.steps)) throw new Error('Bad payload steps');
      return {
        v: p.v || 1,
        title: String(p.title || 'Checklist'),
        source: String(p.source || ''),
        created: Number(p.created || 0),
        steps: p.steps.map(s => ({
          i: Number(s.i),
          z: (s.z == null ? null : String(s.z)),
          layer: (s.layer == null ? null : Number(s.layer)),
          from: String(s.from || ''),
          to: String(s.to || '')
        }))
      };
    }

    async function load() {
      const token = parseTokenFromUrl();
      if (!token) {
        $('empty').style.display = 'block';
        $('empty').innerHTML = `
          <div style="font-weight:1000;margin-bottom:8px">No checklist data in URL.</div>
          <div>Use <span class="mono">generator.html</span> to create a QR/link.</div>
          <div style="margin-top:8px;color:rgba(232,233,240,.55)">Expected: <span class="mono">#d=...</span></div>
        `;
        return;
      }

      try {
        const bytes = b64urlToBytes(token);
        const inflated = await inflate(bytes);
        const jsonStr = bytesToUtf8(inflated);
        const payload = normalizePayload(JSON.parse(jsonStr));

        $('title').textContent = payload.title || 'Checklist';
        $('sub').textContent = payload.source ? ('Source: ' + payload.source) : '';

        const start = startColorName(payload.steps);
        const startPill = $('startPill');
        startPill.innerHTML = '';
        if (start) {
          const sw = document.createElement('span');
          sw.className = 'swatch';
          sw.style.width = sw.style.height = '12px';
          sw.style.background = guessColor(start);
          sw.style.marginRight = '6px';
          sw.style.flexShrink = '0';
          startPill.appendChild(sw);
          startPill.append('START: ' + start.toUpperCase());
          startPill.style.display = 'inline-flex';
        } else {
          startPill.style.display = 'none';
        }

        const id = await sha256Hex(token);
        const stateKey = 'gcodeChecklistState:' + id;

        let state = lsGet(stateKey);
        if (!state || !Array.isArray(state.checked) || state.checked.length !== payload.steps.length) {
          state = { checked: new Array(payload.steps.length).fill(false), updated: Date.now() };
          lsSet(stateKey, state);
        }

        const list = $('list');
        list.innerHTML = '';

        function persist() { state.updated = Date.now(); lsSet(stateKey, state); }

        function onToggle(stepIndex1, value) {
          const idx = stepIndex1 - 1;
          if (idx < 0 || idx >= state.checked.length) return;
          state.checked[idx] = !!value;
          persist();
          updateProgressUI(payload, state.checked);
        }

        for (let i=0;i<payload.steps.length;i++){
          const step = payload.steps[i];
          const row = buildStepRow(step, state.checked[i], onToggle);
          list.appendChild(row);
        }

        updateProgressUI(payload, state.checked);

        $('btnReset').addEventListener('click', () => {
          if (!confirm('Reset checkmarks for this checklist?')) return;
          state.checked = new Array(payload.steps.length).fill(false);
          persist();
          list.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = false);
          updateProgressUI(payload, state.checked);
          toast('Reset.');
        });

        function closeQrModal() {
          $('qrModal').classList.remove('show');
          $('qrModal').setAttribute('aria-hidden', 'true');
        }

        $('btnShareQR').addEventListener('click', async () => {
          const url = location.href;
          $('qrUrl').textContent = url;
          $('qrModal').classList.add('show');
          $('qrModal').setAttribute('aria-hidden', 'false');
          try {
            await drawQr($('qrCanvas'), url);
          } catch (err) {
            toast('Failed to build QR code.');
          }
        });

        $('btnCloseQR').addEventListener('click', closeQrModal);
        $('qrModal').addEventListener('click', (e) => { if (e.target === $('qrModal')) closeQrModal(); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeQrModal(); });

        window.addEventListener('hashchange', () => location.reload());
        window.addEventListener('focus', () => updateProgressUI(payload, state.checked));
      } catch (e) {
        $('empty').style.display = 'block';
        $('empty').textContent = 'Failed to decode checklist: ' + (e && e.message ? e.message : String(e));
      }
    }

    load();
  </script>
</body>
</html>
